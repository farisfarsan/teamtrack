{% extends "base.html" %}
{% block title %}Attendance Sessions - TeamTrack{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Attendance Sessions</h2>
                <p class="text-muted mb-0">Welcome, {{ user.name }}! Manage team member attendance for sessions.</p>
            </div>
            {% if user.team == 'PROJECT_MANAGER' %}
            <div class="btn-group">
                <a href="{% url 'meetings:create' %}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Create New Session
                </a>
                <a href="{% url 'meetings:attendance_stats' %}" class="btn btn-info">
                    <i class="fas fa-chart-bar"></i> Attendance Stats
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Team Overview -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ total_members }}</h3>
                        <small>Total Team Members</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ meetings.count }}</h3>
                        <small>Attendance Sessions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ team_members.count }}</h3>
                        <small>Active Members</small>
                    </div>
                </div>
            </div>
        </div>

        <h3>Attendance Sessions ({{ meetings.count }})</h3>
        
        {% if meetings %}
            <div class="row">
                {% for meeting in meetings %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card meeting-card h-100 border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0">{{ meeting.title }}</h5>
                                <div class="text-end">
                                    <div class="attendance-badge">
                                        <span class="badge bg-info">{{ meeting.get_attendance_stats }}</span>
                                        <small class="text-muted d-block">Attendance</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="small text-muted">
                                    <div class="mb-1">
                                        <i class="fas fa-user-tie"></i> <strong>Organized by:</strong> {{ meeting.organizer.name }}
                                    </div>
                                    <div class="mb-1">
                                        <i class="fas fa-calendar"></i> <strong>Scheduled:</strong> {{ meeting.scheduled_at|date:"M d, Y H:i" }}
                                    </div>
                                    <div class="mb-1">
                                        <i class="fas fa-users"></i> <strong>Team:</strong> {{ meeting.organizer.get_team_display }}
                                    </div>
                                </div>
                            </div>
                            
                            {% if meeting.description %}
                                <p class="card-text text-muted small">{{ meeting.description|truncatewords:15 }}</p>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <a href="{% url 'meetings:detail' meeting.pk %}" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                                <div class="btn-group">
                                    <button class="btn btn-outline-success btn-sm" onclick="markAttendance('{{ meeting.pk }}')">
                                        <i class="fas fa-check"></i> Mark Attendance
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="shareWhatsApp('{{ meeting.pk }}')">
                                        <i class="fab fa-whatsapp"></i> Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-users fa-3x text-muted"></i>
                </div>
                <h4 class="text-muted">No attendance sessions created</h4>
                <p class="text-muted">Create your first attendance session to start tracking team member attendance.</p>
                {% if user.team == 'PROJECT_MANAGER' %}
                <a href="{% url 'meetings:create' %}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Create Your First Session
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Hidden CSRF token for JavaScript -->
{% csrf_token %}

<script>
    function markAttendance(meetingId) {
        // Mark attendance for current user
        fetch(`/meetings/${meetingId}/attendance/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'mark_attendance'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update attendance badge
                const badge = document.querySelector(`[onclick="markAttendance('${meetingId}')"]`).closest('.meeting-card').querySelector('.attendance-badge .badge');
                badge.textContent = data.attendance_count;
                alert('Attendance marked successfully!');
            } else {
                alert('Error marking attendance: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking attendance');
        });
    }

    function shareWhatsApp(meetingId) {
        // Get meeting details and create WhatsApp share link
        const meetingCard = document.querySelector(`[onclick="shareWhatsApp('${meetingId}')"]`).closest('.meeting-card');
        const title = meetingCard.querySelector('.card-title').textContent;
        const scheduled = meetingCard.querySelector('.small').textContent.match(/Scheduled: (.+)/)[1];
        const organizer = meetingCard.querySelector('.small').textContent.match(/Organized by: (.+)/)[1];
        
        const message = `ðŸ“… Meeting Invitation\n\n` +
                      `Title: ${title}\n` +
                      `Organized by: ${organizer}\n` +
                      `Scheduled: ${scheduled}\n` +
                      `\nJoin the meeting: ${window.location.origin}/meetings/${meetingId}/`;
        
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
</script>

<style>
.meeting-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.meeting-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}
</style>
{% endblock %}

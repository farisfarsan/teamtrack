{% extends "base.html" %}
{% block title %}Admin Dashboard - GRYTT{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Admin Dashboard</h2>
                <p class="text-muted mb-0">Team-wise overview of all system activities</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'tasks:task_list' %}" class="btn btn-success">
                    <i class="fas fa-list"></i> View All Tasks
                </a>
                {% if user.team == 'PROJECT_MANAGER' %}
                <a href="{% url 'tasks:task_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Task
                </a>
                <a href="{% url 'meetings:create' %}" class="btn btn-outline-primary">
                    <i class="fas fa-users"></i> Create Attendance Session
                </a>
                <a href="{% url 'meetings:attendance_stats' %}" class="btn btn-info">
                    <i class="fas fa-chart-bar"></i> Attendance Stats
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ total_tasks }}</h3>
                        <p class="mb-0">Total Tasks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ team_members.count }}</h3>
                        <p class="mb-0">Team Members</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ total_sessions }}</h3>
                        <p class="mb-0">Attendance Sessions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3 class="mb-0">{{ active_users }}</h3>
                        <p class="mb-0">Active Users</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Member Attendance Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i> Team Member Attendance Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if team_member_stats %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Team Member</th>
                                        <th>Team</th>
                                        <th>Sessions Attended</th>
                                        <th>Total Sessions</th>
                                        <th>Attendance Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for member_stat in team_member_stats %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                    {{ member_stat.member.name|first|upper }}
                                                </div>
                                                <div>
                                                    <strong>{{ member_stat.member.name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ member_stat.member.email }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ member_stat.member.get_team_display }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-success">{{ member_stat.present_sessions }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ member_stat.total_sessions }}</span>
                                        </td>
                                        <td>
                                            <div class="progress" style="width: 100px;">
                                                <div class="progress-bar 
                                                    {% if member_stat.attendance_rate >= 80 %}bg-success
                                                    {% elif member_stat.attendance_rate >= 60 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    role="progressbar" 
                                                    style="width: {{ member_stat.attendance_rate }}%"
                                                    aria-valuenow="{{ member_stat.attendance_rate }}" 
                                                    aria-valuemin="0" 
                                                    aria-valuemax="100">
                                                    {{ member_stat.attendance_rate }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="{% url 'meetings:attendance_stats' %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-chart-bar"></i> View Details
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No attendance data yet</h5>
                            <p class="text-muted">Create attendance sessions to start tracking team member attendance.</p>
                            <a href="{% url 'meetings:create' %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Create First Session
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Team-wise Dashboard -->
        <div class="row">
            {% for team_name, stats in team_stats.items %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="card h-100 team-card" data-team="{{ team_name }}" style="cursor: pointer;">
                    <div class="card-header bg-{% cycle 'danger' 'info' 'success' 'warning' 'purple' %} text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i> {{ team_name }} Team
                            <i class="fas fa-chevron-down float-end mt-1"></i>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="mb-0 text-primary">{{ stats.total }}</h4>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="mb-0 text-warning">{{ stats.pending }}</h4>
                                    <small class="text-muted">Pending</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <h4 class="mb-0 text-success">{{ stats.completed }}</h4>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">Team Members:</span>
                                <span class="badge bg-secondary">{{ stats.users }}</span>
                            </div>
                        </div>

                        <!-- Team Tasks - Always Visible -->
                        <div class="mb-3">
                            <h6 class="text-muted">Team Tasks</h6>
                            <div class="team-tasks" id="tasks-{{ team_name|slugify }}">
                                {% for task in all_tasks %}
                                    {% if task.get_team_display == team_name %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                        <div>
                                            <strong class="small">{{ task.title|truncatechars:25 }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                Assigned to: {{ task.assigned_to.name }}
                                                {% if task.due_date %}
                                                    • Due: {{ task.due_date|date:"M d" }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-{% if task.status == 'COMPLETED' %}success{% elif task.status == 'IN_PROGRESS' %}primary{% elif task.status == 'PENDING' %}warning{% elif task.status == 'BLOCKED' %}danger{% else %}secondary{% endif %} mb-1">
                                                {{ task.get_status_display }}
                                            </span>
                                            <br>
                                            <span class="badge bg-{% if task.priority == 'HIGH' %}danger{% elif task.priority == 'MEDIUM' %}warning{% else %}success{% endif %}">
                                                {{ task.get_priority_display }}
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% empty %}
                                    <p class="text-muted small">No tasks for this team</p>
                                {% endfor %}
                            </div>
                        </div>

                        {% if user.team == 'PROJECT_MANAGER' %}
                        <div class="d-grid">
                            <a href="{% url 'tasks:task_create' %}?team={{ team_name|slugify }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-plus"></i> Add Task
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Recent Activity -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Recent Tasks</h6>
                                {% for task in recent_tasks %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>{{ task.title }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ task.assigned_to.name }} • {{ task.created_at|date:"M d, H:i" }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-{% if task.team == 'PROJECT_MANAGER' %}danger{% elif task.team == 'DESIGN' %}info{% elif task.team == 'TECH' %}success{% elif task.team == 'MARKETING' %}purple{% else %}warning{% endif %}">
                                            {{ task.get_team_display }}
                                        </span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Recent Attendance Sessions</h6>
                                {% for session in recent_sessions %}
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong>{{ session.title }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ session.organizer.name }} • {{ session.scheduled_at|date:"M d, H:i" }}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-info">{{ session.get_attendance_stats }}</span>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted small">No attendance sessions yet</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-purple {
    background-color: #6f42c1 !important;
}
.team-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.team-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.team-card.expanded {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.team-tasks {
    max-height: 200px;
    overflow-y: auto;
}
.task-detail {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
}
.avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 16px;
    font-weight: bold;
}
.progress {
    height: 20px;
}
.progress-bar {
    font-size: 12px;
    line-height: 20px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Make team cards clickable and show task details
    const teamCards = document.querySelectorAll('.team-card');
    
    teamCards.forEach(function(card) {
        card.addEventListener('click', function(e) {
            // Don't trigger if clicking on buttons or links
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                return;
            }
            
            const teamName = this.dataset.team;
            const tasksContainer = this.querySelector('.team-tasks');
            
            // Toggle expanded state
            this.classList.toggle('expanded');
            
            // Show/hide detailed task information
            if (this.classList.contains('expanded')) {
                showTaskDetails(tasksContainer, teamName);
            } else {
                hideTaskDetails(tasksContainer);
            }
        });
    });
    
    function showTaskDetails(container, teamName) {
        // Add detailed task information
        const tasks = container.querySelectorAll('.bg-light');
        tasks.forEach(function(task) {
            task.classList.add('task-detail');
        });
    }
    
    function hideTaskDetails(container) {
        // Remove detailed styling
        const tasks = container.querySelectorAll('.task-detail');
        tasks.forEach(function(task) {
            task.classList.remove('task-detail');
        });
    }
});
</script>
{% endblock %}